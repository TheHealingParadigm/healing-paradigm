<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Healing Paradigm - Mobile Verified Build</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; touch-action: none; }
        #ui { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; pointer-events: auto; display: none; -webkit-tap-highlight-color: transparent; }
        #buy-btn { background: #27ae60; color: white; }
        #wallet-btn { background: #8e44ad; color: white; }
        #reset-btn { background: #e67e22; color: white; display: inline-block; }
        #status { color: #00ffff; margin-bottom: 10px; font-size: 18px; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="status">CLICK THE DOOR TO ENTER</div>
        <button id="buy-btn" class="btn">BUY NOW</button>
        <button id="wallet-btn" class="btn">CONNECT WALLET</button>
        <button id="reset-btn" class="btn">RESET VIEW</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "tween": "https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.1/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import TWEEN from 'tween';

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const sun = new THREE.DirectionalLight(0xffffff, 0.6);
        sun.position.set(10, 20, 10); scene.add(sun);

        // --- EXTERIOR (KEEPING YOUR BEAUTIFUL DESIGN) ---
        const bld = new THREE.Mesh(new THREE.BoxGeometry(90, 50, 10), new THREE.MeshStandardMaterial({color: 0x89CFF0}));
        bld.position.set(0, 15, -10); scene.add(bld);

        const door = new THREE.Mesh(new THREE.BoxGeometry(12, 20, 1.5), new THREE.MeshStandardMaterial({color: 0x222}));
        door.position.set(0, 5, -2); door.name = "door_trigger"; scene.add(door);

        const winGeo = new THREE.BoxGeometry(18, 18, 1.5);
        const winMat = new THREE.MeshBasicMaterial({color: 0x050505});
        const wL = new THREE.Mesh(winGeo, winMat); wL.position.set(-28, 14, -4); scene.add(wL);
        const wR = new THREE.Mesh(winGeo, winMat); wR.position.set(28, 14, -4); scene.add(wR);

        const sidewalk = new THREE.Mesh(new THREE.BoxGeometry(160, 1, 45), new THREE.MeshStandardMaterial({color: 0x444}));
        sidewalk.position.set(0, -5, 15); scene.add(sidewalk);

        function addStreetLight(x) {
            const g = new THREE.Group();
            const p = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 22), new THREE.MeshStandardMaterial({color: 0x111}));
            const b = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshBasicMaterial({color: 0xffffaa}));
            b.position.y = 11; const l = new THREE.PointLight(0xffaa00, 1500, 60); l.position.y = 11;
            g.add(p, b, l); g.position.set(x, 5, 25); scene.add(g);
        }
        addStreetLight(-45); addStreetLight(45);

        function addPalm(x) {
            const p = new THREE.Group();
            const t = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1.2, 35), new THREE.MeshStandardMaterial({color: 0x664422}));
            const lV = new THREE.Group(); lV.position.y = 17;
            for(let i=0; i<6; i++) {
                const leaf = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 15), new THREE.MeshStandardMaterial({color: 0x228B22}));
                leaf.rotation.z = 1.3; leaf.rotation.y = i * (Math.PI/3); lV.add(leaf);
            }
            p.add(t, lV); p.position.set(x, 7, 35); scene.add(p);
        }
        addPalm(-68); addPalm(68);

        new FontLoader().load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', (font) => {
            const g = new TextGeometry('THE HEALING PARADIGM', { font, size: 4, height: 1 }); g.center();
            const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({color: 0xffffff}));
            m.position.set(0, 30, -3); scene.add(m);
        });

        // --- INTERIOR ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(120, 160), new THREE.MeshStandardMaterial({color: 0xffffff}));
        floor.rotation.x = -Math.PI/2; floor.position.set(0, -4.9, -80); scene.add(floor);

        const table = new THREE.Mesh(new THREE.BoxGeometry(15, 6, 10), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
        table.position.set(0, -2, -45); scene.add(table);

        const counter = new THREE.Mesh(new THREE.BoxGeometry(25, 8, 8), new THREE.MeshStandardMaterial({color: 0xCC5500}));
        counter.position.set(0, -1, -85); scene.add(counter);

        const record = new THREE.Mesh(new THREE.CylinderGeometry(3, 3, 0.15, 64), new THREE.MeshStandardMaterial({color: 0x000, metalness: 0.9}));
        record.position.set(0, 1.1, -45); record.name = "vinyl"; scene.add(record);

        const spot = new THREE.SpotLight(0xffffff, 0, 100, 0.4);
        spot.position.set(0, 30, -45); spot.target = record; scene.add(spot);

        // CLERK WITH HEAD
        const clerk = new THREE.Group();
        const head = new THREE.Mesh(new THREE.SphereGeometry(1.2), new THREE.MeshStandardMaterial({color: 0x5c4033}));
        head.position.y = 10;
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(1.6, 6), new THREE.MeshStandardMaterial({color: 0x222})); body.position.y = 5.5;
        const armL = new THREE.Group(); armL.position.set(-1.8, 8.5, 0); const a1 = new THREE.Mesh(new THREE.BoxGeometry(0.7, 4, 0.7)); a1.position.y = -2; armL.add(a1);
        const armR = new THREE.Group(); armR.position.set(1.8, 8.5, 0); const a2 = new THREE.Mesh(new THREE.BoxGeometry(0.7, 4, 0.7)); a2.position.y = -2; armR.add(a2);
        clerk.add(head, body, armL, armR); clerk.position.set(0, -5, -95); scene.add(clerk);

        // --- HYBRID INPUT HANDLING ---
        let step = 0, dancing = false, confetti = [];
        
        function handleInput(clientX, clientY) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children, true);
            if (!hits.length) return;
            const obj = hits[0].object;

            if (obj.name === "door_trigger") {
                new TWEEN.Tween(camera.position).to({x:0, y:12, z:-10}, 1000).start();
                document.getElementById('status').innerText = "CLICK VINYL RECORD";
            } else if (obj.name === "vinyl") {
                if (step === 0) {
                    new TWEEN.Tween(record.position).to({y: 6.5, z: -25}, 800).start();
                    new TWEEN.Tween(record.rotation).to({x: Math.PI/2}, 800).start();
                    spot.intensity = 6000; step = 1;
                } else if (step === 1) {
                    new TWEEN.Tween(record.position).to({x: 6, y: 3.2, z: -85}, 800).start();
                    new TWEEN.Tween(record.rotation).to({x: 0}, 800).start();
                    new TWEEN.Tween(camera.position).to({x: 0, y: 12, z: -65}, 1000).start();
                    spot.intensity = 0; step = 2;
                    document.getElementById('buy-btn').style.display = 'inline-block';
                    document.getElementById('wallet-btn').style.display = 'inline-block';
                }
            }
        }

        window.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));
        window.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                e.preventDefault();
                handleInput(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        // --- BUTTON ACTIONS ---
        function reset() {
            step = 0; dancing = false;
            new TWEEN.Tween(camera.position).to({x:0, y:15, z:110}, 1000).start();
            record.position.set(0, 1.1, -45); record.rotation.set(0,0,0);
            clerk.position.x = 0; clerk.rotation.y = 0;
            spot.intensity = 0;
            document.querySelectorAll('.btn').forEach(b => b.style.display = 'none');
            document.getElementById('reset-btn').style.display = 'inline-block';
            document.getElementById('status').innerText = "CLICK THE DOOR TO ENTER";
        }

        document.getElementById('buy-btn').addEventListener('click', () => {
            dancing = true;
            new Audio('https://www.myinstants.com/media/sounds/ka-ching.mp3').play();
            for(let i=0; i<100; i++) {
                const c = new THREE.Mesh(new THREE.PlaneGeometry(0.4,0.4), new THREE.MeshBasicMaterial({color: Math.random()*0xffffff, side: 2}));
                c.position.set(Math.random()*30-15, 25, -78 + (Math.random()*6-3)); 
                scene.add(c);
                confetti.push(c);
            }
        });

        document.getElementById('reset-btn').addEventListener('click', reset);
        reset();

        function animate() {
            requestAnimationFrame(animate); TWEEN.update();
            const t = Date.now() * 0.003; // SLOWER DANCE SPEED (Reduced from 0.005)
            confetti.forEach(c => { if(c.position.y > -5) c.position.y -= 0.25; });
            
            if (dancing) {
                const cycle = Math.sin(t*2); // Slower cycle
                clerk.position.y = -5 + Math.abs(Math.sin(t*4)) * 1.5; // Bouncing
                clerk.position.x = cycle * 6; // Wide Sliding
                clerk.rotation.y = cycle * 0.4; // Torso swiveling

                if (cycle > 0) { 
                    armL.rotation.z = 2.6; armR.rotation.z = 0.2; 
                } else { 
                    armR.rotation.z = -2.6; armL.rotation.z = -0.2; 
                }
            }
            camera.lookAt(0, 0, camera.position.z > 0 ? 0 : -120);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
